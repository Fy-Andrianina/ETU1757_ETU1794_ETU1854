<head>
  <link href="<?php echo site_url('assets/css/myCss.css'); ?>" type="text/css" rel="stylesheet" />
  <link href="<?php echo site_url('assets/bootstrap-5.2.0-beta1/dist/css/bootstrap.min.css'); ?>" type="text/css" rel="stylesheet" />
</head>

<?php
$debit_total = array_sum(array_column($ecriture, 'debit'));
$credit_total = array_sum(array_column($ecriture, 'credit'));
$display_button = ($debit_total == $credit_total); ?>

<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <title>Document</title>
      <center>
        <div class="container">
          <h1 class="display-4"><?php echo ($data[0]['description']); ?></h1>
          <p class="lead"><?php echo ($data[0]['dateJournal']); ?></p>
          <p class="lead">
          <h4>Ajouter une écriture</h4>
          </p>
        </div>
      </center>
      <form method="post" action="<?php echo site_url('ecriture_con/ecriture_journal'); ?>" class="needs-validation">
        <input type="hidden" value="<?php echo ($data[0]['id']); ?>" name="idJ" id="idJ">
        <div class="row mb-3">
          <label for="dateRHF" class="col-sm-2 col-form-label">Date de pièce :</label>
          <div class="col-sm-10">
            <input type="date" class="form-control" id="dateRHF" name="dateRHF" required>
            <div class="invalid-feedback">
              Veuillez entrer une date valide.
            </div>
          </div>
        </div>
        <?php if ($display_button) { ?>

          <div class="row mb-3">
            <label for="referencePiece" class="col-sm-2 col-form-label">Réference de pièce :</label>
            <div class="col-sm-10">
              <select name="referencePiece" id="referencePiece" class="form-select" onchange="showAccountNumber('referencePiece','account_piece')">
                <option>Choisir une réference de pièce</option>
                <?php foreach ($pieces as $piece) {
                  $show = $piece['id'] . " - " . $piece['reference']; ?>
                  <option value='<?php echo $show; ?>'><?php echo  $piece['signification']; ?></option>
                <?php } ?>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <label for="account_piece" class="col-sm-2 col-form-label">Valeur:</label>
            <div class="col-sm-10">
              <span id="account_piece"></span>
            </div>
          </div>

          <div class="row mb-3">
            <label for="numeroPiece" class="col-sm-2 col-form-label">Numero de réference/N° facture :</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="numeroPiece" name="numeroPiece" oninput="updatePieceAndRef()" required>
            </div>
          </div>

          <div class="row mb-3">
            <label for="piece_and_ref" class="col-sm-2 col-form-label">Pièce: </label>
            <div class="col-sm-10">
              <span id="piece_and_ref"></span>
            </div>
          </div>


        <?php } else {
        ?>
          <div class="row mb-3">
            <label for="piece_and_ref" class="col-sm-2 col-form-label">Pièce: </label>
            <div class="col-sm-10">
              <span id="piece_and_ref"><?php echo $ecriture[sizeof($ecriture) - 1]['piece']; ?></span>
            </div>
          </div>
          <input type="hidden" value="<?php echo $ecriture[sizeof($ecriture) - 1]['referencePiece']; ?>" name="referencePiece">
          <input type="hidden" value="<?php echo $ecriture[sizeof($ecriture) - 1]['numeroPiece']; ?>" name="numeroPiece">
          <input type="hidden" value="<?php echo $ecriture[sizeof($ecriture) - 1]['piece']; ?>" name="piece">
        <?php } ?>

        <div class="row mb-3">
          <label for="compte-general" class="col-sm-2 col-form-label">N° Compte général :</label>
          <div class="col-sm-10"> <!-- onchange="showAccountNumber('compte-general','account_general'), getIfNeedTiers('compte-general','compte-tiers')" -->
            <select name="compte-general" id="compte-general" class="form-select" onchange="showAccountNumber('compte-general','account_general','compte_aux')">
              <option>Choisir un compte</option>
              <?php foreach ($compteG as $cg) {
                $show = $cg['id'] . " - " . $cg['numeroCompte']; ?>
                <option value='<?php echo $show; ?>'><?php echo $cg['description']; ?></option>
              <?php } ?>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <label for="account_general" class="col-sm-2 col-form-label">Valeur:</label>
          <div class="col-sm-10">
            <span id="account_general"></span>
          </div>
        </div>

        <div class="row mb-3" id="compte_aux">
          <label for="compte-tiers" class="col-sm-2 form-label">N° Compte tiers :</label>
          <div class="col-sm-10">
            <select name="compte-tiers" id="compte-tiers" onchange="showAccountNumber('compte-tiers','account_tiers', null)" class="form-select">
              <option>Choisir un compte</option>
              <?php foreach ($compteT as $ct) {
                $show = $ct['id'] . " - " . $ct['numeroCompte']; ?>
                <option value='<?php echo $show; ?>'><?php echo $ct['description']; ?></option>
              <?php } ?>
            </select>
          </div>
        </div>

        <div class="row mb-3" id="compte_aux">
          <label for="account_tiers" id="compte_aux" class="col-sm-2 col-form-label">Valeur: </label>
          <div class="col-sm-10">
            <span id="account_tiers" class="form-control-static"></span>
          </div>
        </div>

        <div class="row mb-3">
          <label for="libelle" class="col-sm-2 form-label">Libéllé écriture :</label>
          <div class="col-sm-10">
            <input type="text" id="libelle" name="libelle" class="form-control" required>
          </div>
        </div>

        <div class="row mb-3">
          <label for="devise" class="col-sm-2 form-label">Devise :</label>
          <div class="col-sm-10">
            <select name="devise" id="devise" class="form-control">
              <?php foreach ($devise as $devise) { ?>
                <option value=<?php echo $devise['id']; ?>><?php echo $devise['nom']; ?></option>
              <?php } ?>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <label for="debit" class="col-sm-2 form-label">Débit:</label>
          <div class="col-sm-10">
            <input type="number" id="debit" name="debit" oninput="updateCreditValue()" class="form-control">
          </div>
        </div>

        <div class="row mb-3">
          <label for="credit" class="col-sm-2 form-label">Crédit:</label>
          <div class="col-sm-10">
            <input type="number" id="credit" name="credit" oninput="updateDebitValue()" class="form-control">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-offset-2 col-sm-10">
            <input type="submit" value="Soumettre" class="btn btn-outline-secondary">
          </div>
        </div>
      </form>

      </form>
      <!--id="ajouter-button" !-->
      <center>
        <h4 class="display-9">JOURNAL COMPTABLE</h4>
      </center>

      <table id="result-table" class="table table-hover">
        <thead>
          <tr>
            <th>Date de pièce</th>
            <th>Pièce</th>
            <th>N° compte général</th>
            <th>N° Compte tiers</th>
            <th>Libéllé écriture</th>
            <th>Devise</th>
            <th>Débit</th>
            <th>Crédit</th>
          </tr>
        </thead>
        <tbody id="journal-body">

          <?php
          if ($ecriture != null) {
            foreach ($ecriture as $ecritures) : ?>
              <tr>
                <td><?php echo $ecritures['dateRHF']; ?></td>
                <td><?php echo $ecritures['piece']; ?></td>
                <td><?php echo $ecritures['idCompteGeneral']; ?></td>
                <td><?php echo $ecritures['idCompteTiers']; ?></td>
                <td><?php echo $ecritures['libelle']; ?></td>
                <td><?php echo $ecritures['idDevise']; ?></td>
                <td><?php echo $ecritures['debit']; ?></td>
                <td><?php echo $ecritures['credit']; ?></td>
                <?php
                $idJournal = $data[0]['id'];
                $piece =  $ecritures['piece'];
                ?>
                <td><a href="<?php echo base_url('ecriture_con/deleteEcritureAndABout?idJournal=' . $idJournal . '&piece=' . $piece); ?>">Effacer</a></td>
              </tr>
          <?php endforeach;
          } ?>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="6">Total</td>
            <td><?php echo array_sum(array_column($ecriture, 'debit')); ?></td>
            <td><?php echo array_sum(array_column($ecriture, 'credit')); ?></td>
          </tr>
        </tfoot>
      </table>


      <?php
      if ($display_button) { ?>
        <form method="get" action="<?php echo site_url('ecriture_con/save_grandLivre'); ?>">
          <input type="hidden" value="<?php echo ($data[0]['id']); ?>" name="idJournal" id="idJournal">
          <input type="submit" value="Soumettre" class="btn btn-outline-secondary">
        </form>
      <?php } else {
      } ?>

    </div>
  </div>
</div>
</div>
<script>
  // récupérer la référence vers le formulaire et la table des résultats
  const form = document.querySelector('#journal-form');
  const resultTable = document.querySelector('#result-table');

  // ajouter un gestionnaire d'événement pour la soumission du formulaire
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // empêcher le comportement par défaut (rechargement de la page)

    // créer un objet FormData pour récupérer les valeurs du formulaire
    const formData = new FormData(form);

    // envoyer une requête AJAX POST avec les valeurs du formulaire
    fetch(form.action, {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(html => {
        // insérer le HTML renvoyé par le serveur dans la table des résultats
        resultTable.innerHTML = html;
      })
      .catch(error => {
        console.error(error);
      });
  });


  function updatePieceAndRef() {
    var accountPiece = document.getElementById("account_piece").textContent.trim();
    if (accountPiece == "undefined") {
      accountPiece = "";
    }
    var numeroPiece = document.getElementById("numeroPiece").value.trim();
    var pieceAndRef = accountPiece + numeroPiece;
    document.getElementById("piece_and_ref").textContent = pieceAndRef;
  }

  // call the updatePieceAndRef() function once on page load to set the initial value
  updatePieceAndRef();

  function updateCreditValue() {
    const debit = document.getElementById('debit').value;
    const credit = document.getElementById('credit');

    if (debit) {
      credit.value = 0;
    } else {
      credit.value = '';
    }
  }

  function updateDebitValue() {
    const credit = document.getElementById('credit').value;
    const debit = document.getElementById('debit');

    if (credit) {
      debit.value = 0;
    } else {
      debit.value = '';
    }
  }

  function showAccountNumber(value, valeurs, todelete) {
    var select = document.getElementById(value);
    var selectedValue = select.options[select.selectedIndex].value;
    var array = selectedValue.split(" - ");
    document.getElementById(valeurs).innerHTML = array[1];
    if (array[1][0] != '4') {
      document.getElementById(todelete).style.display = "none";
    } else {
      document.getElementById(todelete).style.display = "block";
    }
  }
</script>












<head>
  <link href="<?php echo site_url('assets/css/myCss.css'); ?>" type="text/css" rel="stylesheet" />
  <link href="<?php echo site_url('assets/bootstrap-5.2.0-beta1/dist/css/bootstrap.min.css'); ?>" type="text/css" rel="stylesheet" />
</head>

<?php
$debit_total = array_sum(array_column($ecriture, 'debit'));
$credit_total = array_sum(array_column($ecriture, 'credit'));
$display_button = ($debit_total == $credit_total); ?>

<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <title>Document</title>
      <center>
        <div class="container">
          <h1 class="display-4"><?php echo ($data[0]['description']); ?></h1>
          <p class="lead"><?php echo ($data[0]['dateJournal']); ?></p>
          <p class="lead">
          <h4>Ajouter une écriture</h4>
          </p>
        </div>
      </center>
      <form method="post" action="<?php echo site_url('ecriture_con/ecriture_journal'); ?>" class="needs-validation">
        <input type="hidden" value="<?php echo ($data[0]['id']); ?>" name="idJ" id="idJ">


        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Date de pièce</th>
                      <th>Référence de pièce</th>
                      <?php if ($display_button) { ?>
                      <th>Numero de réference/N° facture </th>
                      <?php } ?>
                      <th>Compte général</th>
                      <th id="lib">Compte de tiers</th>
                      <th>Libelle</th>
                      <th>Devise</th>
                      <th>Débit</th>
                      <th>Crédit</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><input type="date" class="form-control" id="dateRHF" name="dateRHF" required></td>
                      <?php if ($display_button) { ?>
                        <td>
                          <select name="referencePiece" id="referencePiece" class="form-select" onchange="showAccountNumber('referencePiece','account_piece')">
                            <option>Choisir une réference de pièce</option>
                            <?php foreach ($pieces as $piece) {
                              $show = $piece['id'] . " - " . $piece['reference']; ?>
                              <option value='<?php echo $show; ?>'><?php echo  $piece['signification']; ?></option>
                            <?php } ?>
                          </select>
                        </td>
                        <td><input type="text" class="form-control" id="numeroPiece" name="numeroPiece" oninput="updatePieceAndRef()" required></td>
                      <?php } else { ?>
                        <td>
                          <span id="piece_and_ref"><?php echo $ecriture[sizeof($ecriture) - 1]['piece']; ?></span>
                          <input type="hidden" value="<?php echo $ecriture[sizeof($ecriture) - 1]['referencePiece']; ?>" name="referencePiece">
                          <input type="hidden" value="<?php echo $ecriture[sizeof($ecriture) - 1]['numeroPiece']; ?>" name="numeroPiece">
                          <input type="hidden" value="<?php echo $ecriture[sizeof($ecriture) - 1]['piece']; ?>" name="piece">
                        </td>
                      <?php } ?>
                      <td>
                        <select name="compte-general" id="compte-general" class="form-select" onchange="showAccountNumber('compte-general','account_general','compte_aux','lib')">
                          <option>Choisir un compte</option>
                          <?php foreach ($compteG as $cg) {
                            $show = $cg['id'] . " - " . $cg['numeroCompte']; ?>
                            <option value='<?php echo $show; ?>'><?php echo $cg['description']; ?></option>
                          <?php } ?>
                        </select>
                      </td>
                      <td id="compte_aux">
                        <select name="compte-tiers" id="compte-tiers" onchange="showAccountNumber('compte-tiers','account_tiers', null)" class="form-select">
                          <option>Choisir un compte</option>
                          <?php foreach ($compteT as $ct) {
                            $show = $ct['id'] . " - " . $ct['numeroCompte']; ?>
                            <option value='<?php echo $show; ?>'><?php echo $ct['description']; ?></option>
                          <?php } ?>
                        </select>
                        </div>
                      </td>
                      <td><input type="text" id="libelle" name="libelle" class="form-control" required></td>
                      <td>
                        <select name="devise" id="devise" class="form-control">
                          <?php foreach ($devise as $devise) { ?>
                            <option value=<?php echo $devise['id']; ?>><?php echo $devise['nom']; ?></option>
                          <?php } ?>
                        </select>
                      </td>
                      <td> <input type="number" id="debit" name="debit" oninput="updateCreditValue()" class="form-control"></td>
                      <td> <input type="number" id="credit" name="credit" oninput="updateCreditValue()" class="form-control"></td>
                    </tr>
                    <tr>
                      <td></td>
                      <?php if ($display_button) { ?>
                        <td id="account_piece"></td>
                        <td id="piece_and_ref"></td>
                      <?php } else { ?>
                        <td id="piece_and_ref"></td>
                      <?php } ?>
                      <td id="account_general"></td>
                      <td id="compte_aux">
                        <span id="account_tiers"></span>
                      </td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td>
                        <div class="row mb-3">
                          <div class="col-sm-offset-2 col-sm-10">
                            <input type="submit" value="Soumettre" class="btn btn-outline-secondary">
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>

              </div>
            </div>
          </div>
        </div>

      </form>
      <!--id="ajouter-button" !-->
      <center>
        <h4 class="display-9">JOURNAL COMPTABLE</h4>
      </center>

      <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
              <thead>
                <tr>
                  <th>Date de pièce</th>
                  <th>Pièce</th>
                  <th>N° compte général</th>
                  <th>N° Compte tiers</th>
                  <th>Libéllé écriture</th>
                  <th>Devise</th>
                  <th>Débit</th>
                  <th>Crédit</th>
                </tr>
              </thead>
              <tbody id="journal-body">

                <?php
                if ($ecriture != null) {
                  foreach ($ecriture as $ecritures) : ?>
                    <tr>
                      <td><?php echo $ecritures['dateRHF']; ?></td>
                      <td><?php echo $ecritures['piece']; ?></td>
                      <td><?php echo $ecritures['idCompteGeneral']; ?></td>
                      <td><?php echo $ecritures['idCompteTiers']; ?></td>
                      <td><?php echo $ecritures['libelle']; ?></td>
                      <td><?php echo $ecritures['idDevise']; ?></td>
                      <td><?php echo $ecritures['debit']; ?></td>
                      <td><?php echo $ecritures['credit']; ?></td>
                      <?php
                      $idJournal = $data[0]['id'];
                      $piece =  $ecritures['piece'];
                      ?>
                      <td><a href="<?php echo base_url('ecriture_con/deleteEcritureAndABout?idJournal=' . $idJournal . '&piece=' . $piece); ?>">Effacer</a></td>
                    </tr>
                <?php endforeach;
                } ?>
              </tbody>
                <tr>
                  <td colspan="6">Total</td>
                  <td><?php echo array_sum(array_column($ecriture, 'debit')); ?></td>
                  <td><?php echo array_sum(array_column($ecriture, 'credit')); ?></td>
                </tr>
            </table>
          </div>
        </div>

      </div>
    </div>

    <?php
    if ($display_button) { ?>
      <form method="get" action="<?php echo site_url('ecriture_con/save_grandLivre'); ?>">
        <input type="hidden" value="<?php echo ($data[0]['id']); ?>" name="idJournal" id="idJournal">
        <input type="submit" value="Soumettre" class="btn btn-outline-secondary">
      </form>
    <?php } else {
    } ?>

  </div>
</div>
</div>
</div>
<script>
  // récupérer la référence vers le formulaire et la table des résultats
  const form = document.querySelector('#journal-form');
  const resultTable = document.querySelector('#result-table');

  // ajouter un gestionnaire d'événement pour la soumission du formulaire
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // empêcher le comportement par défaut (rechargement de la page)

    // créer un objet FormData pour récupérer les valeurs du formulaire
    const formData = new FormData(form);

    // envoyer une requête AJAX POST avec les valeurs du formulaire
    fetch(form.action, {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(html => {
        // insérer le HTML renvoyé par le serveur dans la table des résultats
        resultTable.innerHTML = html;
      })
      .catch(error => {
        console.error(error);
      });
  });


  function updatePieceAndRef() {
    var accountPiece = document.getElementById("account_piece").textContent.trim();
    if (accountPiece == "undefined") {
      accountPiece = "";
    }
    var numeroPiece = document.getElementById("numeroPiece").value.trim();
    var pieceAndRef = accountPiece + numeroPiece;
    document.getElementById("piece_and_ref").textContent = pieceAndRef;
  }

  // call the updatePieceAndRef() function once on page load to set the initial value
  updatePieceAndRef();

  function updateCreditValue() {
    const debit = document.getElementById('debit').value;
    const credit = document.getElementById('credit');

    if (debit) {
      credit.value = 0;
    } else {
      credit.value = '';
    }
  }

  function updateDebitValue() {
    const credit = document.getElementById('credit').value;
    const debit = document.getElementById('debit');

    if (credit) {
      debit.value = 0;
    } else {
      debit.value = 0;
    }
  }

  function showAccountNumber(value, valeurs, todelete, todelete1) {
    var select = document.getElementById(value);
    var selectedValue = select.options[select.selectedIndex].value;
    var array = selectedValue.split(" - ");
    document.getElementById(valeurs).innerHTML = array[1];
    if (array[1][0] != '4') {
      document.getElementById(todelete).style.display = "none";
      document.getElementById(todelete1).style.display = "none";
    } else {
      document.getElementById(todelete).style.display = "block";
      document.getElementById(todelete1).style.display = "block";
    }
  }
</script>